# Custom Food Entry - –ü—Ä—è–º–æ–π –≤–≤–æ–¥ –ö–ë–ñ–£

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä—è–º–æ–≥–æ –≤–≤–æ–¥–∞ –ø–∏—â–µ–≤–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –±–µ–∑ –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ FatSecret. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç:

1. **–£–∫–∞–∑–∞—Ç—å –ö–ë–ñ–£ –Ω–∞–ø—Ä—è–º—É—é** –¥–ª—è —Å—ä–µ–¥–µ–Ω–Ω–æ–π –ø–æ—Ä—Ü–∏–∏
2. **–£–∫–∞–∑–∞—Ç—å –ö–ë–ñ–£ –Ω–∞ 100–≥** –∏ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤–≤–æ–¥–∞

### 1. –ü—Ä—è–º–æ–π –≤–≤–æ–¥ –ö–ë–ñ–£ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ—Ä—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä—ã:**
```
–°—ä–µ–ª 150 –≥—Ä–∞–º–º —Å–∞–ª–∞—Ç–∞ —Å —Ç—É–Ω—Ü–æ–º –ë–ñ–£ 50/50/50 –∫–∞–ª–æ—Ä–∏–π 150
150–≥ –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –ö–ë–ñ–£ 250/40/0/5
–û–º–ª–µ—Ç 200–≥ –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 300
```

**–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
- `–ë–ñ–£ X/Y/Z` ‚Üí –ë–µ–ª–∫–∏/–ñ–∏—Ä—ã/–£–≥–ª–µ–≤–æ–¥—ã
- `–ö–ë–ñ–£ W/X/Y/Z` ‚Üí –ö–∞–ª–æ—Ä–∏–∏/–ë–µ–ª–∫–∏/–ñ–∏—Ä—ã/–£–≥–ª–µ–≤–æ–¥—ã
- `–∫–∞–ª–æ—Ä–∏–π N` –∏–ª–∏ `–∫–∫–∞–ª N` ‚Üí –ö–∞–ª–æ—Ä–∏–∏
- `–±–µ–ª–∫–∏ X`, `–∂–∏—Ä—ã Y`, `—É–≥–ª–µ–≤–æ–¥—ã Z` ‚Üí –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–æ—Ç:**
1. –†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ("—Å–∞–ª–∞—Ç–∞ —Å —Ç—É–Ω—Ü–æ–º")
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤–µ—Å (150–≥)
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ö–ë–ñ–£ (–ë:50–≥, –ñ:50–≥, –£:50–≥, –ö–∞–ª–æ—Ä–∏–∏:150)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –¥–Ω–µ–≤–Ω–∏–∫ "–∫–∞–∫ –µ—Å—Ç—å" (–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è 150–≥)

### 2. –ö–ë–ñ–£ –Ω–∞ 100–≥ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ—Å—á—ë—Ç–æ–º

**–ü—Ä–∏–º–µ—Ä—ã:**
```
–°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –Ω–∞ 100–≥
–ù–∞ 100 –≥—Ä–∞–º–º: –∫–∞–ª–æ—Ä–∏–∏ 350, –±–µ–ª–∫–∏ 20, –∂–∏—Ä—ã 10, —É–≥–ª–µ–≤–æ–¥—ã 40
–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫ –ö–ë–ñ–£ 400/25/15/50 per 100g
```

**–ï—Å–ª–∏ –≤–µ—Å –ù–ï —É–∫–∞–∑–∞–Ω:**
```
User: "–°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –Ω–∞ 100–≥"
Bot: "–°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º '–°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º' –≤—ã —Å—ä–µ–ª–∏?"
User: "200"
Bot: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: –°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º 200–≥
     –ö–∞–ª–æ—Ä–∏–∏: 500 –∫–∫–∞–ª (–ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ —Å 100–≥)
     –ë: 60–≥, –ñ: 40–≥, –£: 20–≥
```

**–ï—Å–ª–∏ –≤–µ—Å —É–∫–∞–∑–∞–Ω —Å—Ä–∞–∑—É:**
```
User: "200–≥ —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –Ω–∞ 100–≥"
Bot: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º 200–≥
     –ö–∞–ª–æ—Ä–∏–∏: 500 –∫–∫–∞–ª (–ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ —Å 100–≥)
     –ë: 60–≥, –ñ: 40–≥, –£: 20–≥
```

**–§–æ—Ä–º—É–ª–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞:**
```python
—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ_–∫–∞–ª–æ—Ä–∏–∏ = (–∫–∞–ª–æ—Ä–∏–∏_–Ω–∞_100–≥ / 100) * —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–≤–µ—Å_–≥
—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–±–µ–ª–æ–∫ = (–±–µ–ª–æ–∫_–Ω–∞_100–≥ / 100) * —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–≤–µ—Å_–≥
# –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∂–∏—Ä–æ–≤ –∏ —É–≥–ª–µ–≤–æ–¥–æ–≤
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (GPT-4)

**–ù–æ–≤–∞—è schema –¥–ª—è parse_food_text:**
```json
{
  "items": [
    {
      "name": "food name",
      "quantity": 150,
      "unit": "g",
      "custom_nutrition": {
        "calories": 150,
        "protein": 50,
        "carbs": 50,
        "fat": 50,
        "is_per_100g": false
      }
    }
  ]
}
```

**–ü–æ–ª—è custom_nutrition:**
- `calories` - –∫–∞–ª–æ—Ä–∏–∏ (—á–∏—Å–ª–æ)
- `protein` - –±–µ–ª–∫–∏ –≤ –≥—Ä–∞–º–º–∞—Ö
- `carbs` - —É–≥–ª–µ–≤–æ–¥—ã –≤ –≥—Ä–∞–º–º–∞—Ö
- `fat` - –∂–∏—Ä—ã –≤ –≥—Ä–∞–º–º–∞—Ö
- `is_per_100g` - true –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ 100–≥, false –µ—Å–ª–∏ –¥–ª—è –≤—Å–µ–π –ø–æ—Ä—Ü–∏–∏

### Workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
User Input
    ‚Üì
[normalize_input] ‚Üê GPT-4 –ø–∞—Ä—Å–∏–Ω–≥
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å custom_nutrition?
    ‚îú‚îÄ‚îÄ –ù–µ—Ç ‚Üí [fatsecret_search] (–æ–±—ã—á–Ω—ã–π flow)
    ‚îî‚îÄ‚îÄ –î–∞ ‚Üí [process_custom_nutrition]
              ‚Üì
          –ü—Ä–æ–≤–µ—Ä–∫–∞: is_per_100g?
              ‚îú‚îÄ‚îÄ true + –Ω–µ—Ç –≤–µ—Å–∞ ‚Üí [need_clarification] ‚Üí —Å–ø—Ä–æ—Å–∏—Ç—å –≤–µ—Å
              ‚îú‚îÄ‚îÄ true + –µ—Å—Ç—å –≤–µ—Å ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å ‚Üí [save_entry]
              ‚îî‚îÄ‚îÄ false + –µ—Å—Ç—å –≤–µ—Å ‚Üí —Å—Ä–∞–∑—É [save_entry]
                         ‚Üì
                   [calculate_totals]
                         ‚Üì
                   [generate_advice]
```

### –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. process_custom_nutrition node

**–§–∞–π–ª:** [services/agent-api/src/graph/nodes/process_custom_nutrition.py](services/agent-api/src/graph/nodes/process_custom_nutrition.py)

**–§—É–Ω–∫—Ü–∏–∏:**
```python
async def process_custom_nutrition(state: NutritionBotState) -> Dict[str, Any]:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç custom nutrition entries.

    –õ–æ–≥–∏–∫–∞:
    1. –ï—Å–ª–∏ is_per_100g=true –∏ –≤–µ—Å –µ—Å—Ç—å ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
    2. –ï—Å–ª–∏ is_per_100g=false ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å
    3. –ï—Å–ª–∏ –≤–µ—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å clarification
    """

def calculate_nutrition_from_100g(
    nutrition_per_100g: Dict[str, float],
    actual_weight_g: float
) -> Dict[str, float]:
    """
    –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç nutrition —Å 100–≥ –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å.

    Args:
        nutrition_per_100g: –ö–ë–ñ–£ –Ω–∞ 100–≥
        actual_weight_g: –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö

    Returns:
        –ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ö–ë–ñ–£
    """
    multiplier = actual_weight_g / 100.0
    return {
        "calories": nutrition_per_100g["calories"] * multiplier,
        "protein": nutrition_per_100g["protein"] * multiplier,
        "carbohydrate": nutrition_per_100g["carbs"] * multiplier,
        "fat": nutrition_per_100g["fat"] * multiplier
    }
```

#### 2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π GPT-4 –ø—Ä–æ–º–ø—Ç

**–§–∞–π–ª:** [services/agent-api/src/services/openai_service.py](services/agent-api/src/services/openai_service.py)

**–ù–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
```
RULES FOR CUSTOM NUTRITION INPUT:
User can provide nutrition data directly in formats like:
- "–ë–ñ–£ 50/50/50 –∫–∞–ª–æ—Ä–∏–π 150"
- "–ö–ë–ñ–£ 150/50/50/50"
- "–∫–∞–ª–æ—Ä–∏–π 250 –ë–ñ–£ 30/20/10 –Ω–∞ 100–≥"
- "–Ω–∞ 100 –≥—Ä–∞–º–º: –∫–∞–ª–æ—Ä–∏–∏ 350, –±–µ–ª–∫–∏ 20, –∂–∏—Ä—ã 10, —É–≥–ª–µ–≤–æ–¥—ã 40"

When user provides nutrition data:
1. Extract exact values (do NOT calculate anything)
2. Set is_per_100g = true if user says "–Ω–∞ 100–≥" / "per 100g"
3. Set is_per_100g = false otherwise
4. Include all nutrition data in custom_nutrition field
```

#### 3. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π graph routing

**–§–∞–π–ª:** [services/agent-api/src/graph/graph.py](services/agent-api/src/graph/graph.py)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ù–æ–≤—ã–π node `process_custom_nutrition`
- Routing function `route_after_custom_nutrition`
- Conditional edges –∏–∑ `normalize_input` ‚Üí `process_custom_nutrition`

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

Custom entries —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å —Ñ–ª–∞–≥–æ–º `is_custom=True` –≤ —Ç–∞–±–ª–∏—Ü—É `food_log_entry`:

```sql
INSERT INTO food_log_entry (
    user_id,
    food_id,  -- NULL –¥–ª—è custom entries
    food_name,  -- "–°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º"
    serving_description,  -- "150g"
    serving_amount,  -- 150
    serving_unit,  -- "g"
    number_of_servings,  -- 1.0
    calories,  -- –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    protein,  -- –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    carbohydrates,  -- –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    fat,  -- –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    is_custom,  -- TRUE
    ...
)
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä—è–º–æ–π –≤–≤–æ–¥ –ö–ë–ñ–£ —Å –≤–µ—Å–æ–º

**Input:**
```
User: –°—ä–µ–ª 150 –≥—Ä–∞–º–º —Å–∞–ª–∞—Ç–∞ —Å —Ç—É–Ω—Ü–æ–º –ë–ñ–£ 50/50/50 –∫–∞–ª–æ—Ä–∏–π 600
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
1. GPT-4 –ø–∞—Ä—Å–∏—Ç:
   ```json
   {
     "name": "—Å–∞–ª–∞—Ç–∞ —Å —Ç—É–Ω—Ü–æ–º",
     "quantity": 150,
     "unit": "g",
     "custom_nutrition": {
       "protein": 50,
       "fat": 50,
       "carbs": 50,
       "calories": 600,
       "is_per_100g": false
     }
   }
   ```

2. `process_custom_nutrition` —Å–æ–∑–¥–∞—ë—Ç entry:
   - –ö–∞–ª–æ—Ä–∏–∏: 600 –∫–∫–∞–ª
   - –ë–µ–ª–∫–∏: 50–≥
   - –ñ–∏—Ä—ã: 50–≥
   - –£–≥–ª–µ–≤–æ–¥—ã: 50–≥
   - –í–µ—Å: 150–≥
   - is_custom: true

3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î

**Output:**
```
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: —Å–∞–ª–∞—Ç–∞ —Å —Ç—É–Ω—Ü–æ–º 150–≥
–ö–∞–ª–æ—Ä–∏–∏: 600 –∫–∫–∞–ª
–ë: 50–≥, –ñ: 50–≥, –£: 50–≥

üìä –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è:
–ö–∞–ª–æ—Ä–∏–∏: 600 / 2000 –∫–∫–∞–ª (30%)
...
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö–ë–ñ–£ –Ω–∞ 100–≥ –ë–ï–ó –≤–µ—Å–∞

**Input:**
```
User: –°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –Ω–∞ 100–≥
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
1. GPT-4 –ø–∞—Ä—Å–∏—Ç:
   ```json
   {
     "name": "–°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º",
     "quantity": null,  ‚Üê –í–ï–° –û–¢–°–£–¢–°–¢–í–£–ï–¢
     "unit": "g",
     "custom_nutrition": {
       "protein": 30,
       "fat": 20,
       "carbs": 10,
       "calories": 250,
       "is_per_100g": true  ‚Üê –ù–ê 100–ì
     }
   }
   ```

2. `process_custom_nutrition` —Å–æ–∑–¥–∞—ë—Ç clarification request

**Output:**
```
Bot: –°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º '–°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º' –≤—ã —Å—ä–µ–ª–∏?
```

**User response:**
```
User: 200
```

**–ü–µ—Ä–µ—Å—á—ë—Ç:**
```python
calories = (250 / 100) * 200 = 500 –∫–∫–∞–ª
protein = (30 / 100) * 200 = 60–≥
fat = (20 / 100) * 200 = 40–≥
carbs = (10 / 100) * 200 = 20–≥
```

**Final output:**
```
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: –°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º 200–≥
–ö–∞–ª–æ—Ä–∏–∏: 500 –∫–∫–∞–ª (–ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ —Å 100–≥)
–ë: 60–≥, –ñ: 40–≥, –£: 20–≥
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ö–ë–ñ–£ –Ω–∞ 100–≥ –° –≤–µ—Å–æ–º

**Input:**
```
User: 200–≥ —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º –Ω–∞ 100 –≥—Ä–∞–º–º: –∫–∞–ª–æ—Ä–∏–∏ 250, –±–µ–ª–∫–∏ 30, –∂–∏—Ä—ã 20, —É–≥–ª–µ–≤–æ–¥—ã 10
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
1. GPT-4 –ø–∞—Ä—Å–∏—Ç:
   ```json
   {
     "name": "—Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º",
     "quantity": 200,  ‚Üê –í–ï–° –ï–°–¢–¨
     "unit": "g",
     "custom_nutrition": {
       "calories": 250,
       "protein": 30,
       "fat": 20,
       "carbs": 10,
       "is_per_100g": true  ‚Üê –ù–ê 100–ì
     }
   }
   ```

2. `process_custom_nutrition` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç:
   - –ö–∞–ª–æ—Ä–∏–∏: (250/100) * 200 = 500
   - –ë–µ–ª–∫–∏: (30/100) * 200 = 60
   - –ñ–∏—Ä—ã: (20/100) * 200 = 40
   - –£–≥–ª–µ–≤–æ–¥—ã: (10/100) * 200 = 20

3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ä–∞–∑—É –ë–ï–ó clarification

**Output:**
```
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º 200–≥
–ö–∞–ª–æ—Ä–∏–∏: 500 –∫–∫–∞–ª
–ë: 60–≥, –ñ: 40–≥, –£: 20–≥
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–ö–ë–ñ–£)

**Input:**
```
User: 100–≥ –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫ –ö–ë–ñ–£ 400/25/15/50
```

**–ü–∞—Ä—Å–∏–Ω–≥:**
```json
{
  "name": "–ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫",
  "quantity": 100,
  "unit": "g",
  "custom_nutrition": {
    "calories": 400,
    "protein": 25,
    "fat": 15,
    "carbs": 50,
    "is_per_100g": false
  }
}
```

**Output:**
```
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫ 100–≥
–ö–∞–ª–æ—Ä–∏–∏: 400 –∫–∫–∞–ª
–ë: 25–≥, –ñ: 15–≥, –£: 50–≥
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –ë—ã—Å—Ç—Ä–æ—Ç–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥—ë—Ç –ø–æ–∏—Å–∫–∞ –≤ FatSecret, –µ—Å–ª–∏ –∑–Ω–∞–µ—Ç –ö–ë–ñ–£:
- –û–±—ã—á–Ω—ã–π flow: –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –ø–æ–∏—Å–∫ ‚Üí –≤—ã–±–æ—Ä ‚Üí –ø–æ—Ä—Ü–∏—è ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (5-10 —Å–µ–∫)
- Custom flow: –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (2-3 —Å–µ–∫)

### 2. –¢–æ—á–Ω–æ—Å—Ç—å

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —É–ø–∞–∫–æ–≤–∫–∏):
- Custom entry: —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–∫–µ—Ç–∫–∏
- FatSecret: –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è

### 3. –ì–∏–±–∫–æ—Å—Ç—å

–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è:
- –î–æ–º–∞—à–Ω–∏—Ö –±–ª—é–¥ ("–º–∞–º–∏–Ω –±–æ—Ä—â –ë–ñ–£ ...")
- –†–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –±–ª—é–¥ —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å—é
- –ü—Ä–æ–¥—É–∫—Ç–æ–≤ —Å —ç—Ç–∏–∫–µ—Ç–∫–æ–π –Ω–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ
- –õ—é–±—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ FatSecret

### 4. –£–¥–æ–±—Å—Ç–≤–æ —Å —ç—Ç–∏–∫–µ—Ç–∫–∞–º–∏

–ï—Å–ª–∏ –Ω–∞ —É–ø–∞–∫–æ–≤–∫–µ —É–∫–∞–∑–∞–Ω–æ "–Ω–∞ 100–≥":
```
–£–ø–∞–∫–æ–≤–∫–∞: "–ù–∞ 100–≥: 350 –∫–∫–∞–ª, –ë: 20–≥, –ñ: 10–≥, –£: 40–≥"
User: "–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫ –Ω–∞ 100–≥ –∫–∞–ª–æ—Ä–∏–∏ 350 –ë–ñ–£ 20/10/40"
Bot: "–°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º?"
User: "60"  (–≤–µ—Å –±–∞—Ç–æ–Ω—á–∏–∫–∞)
Bot: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: 60–≥ (–ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤

Custom entries –ù–ï –≤–∫–ª—é—á–∞—é—Ç:
- –ö–ª–µ—Ç—á–∞—Ç–∫—É (fiber)
- –°–∞—Ö–∞—Ä (sugar)
- –ù–∞—Ç—Ä–∏–π (sodium)

–≠—Ç–∏ –ø–æ–ª—è –±—É–¥—É—Ç `null` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### 2. –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥

Custom entries —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥. –ù–µ—Ç UI –¥–ª—è "–¥–æ–±–∞–≤–∏—Ç—å custom –ø—Ä–æ–¥—É–∫—Ç".

### 3. –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É

–ö–∞–∂–¥—ã–π —Ä–∞–∑ –Ω—É–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –∑–∞–Ω–æ–≤–æ. –ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ "—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø—Ä–æ–¥—É–∫—Ç".

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ custom products

–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö custom entries:
```
User: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å '–º–∞–º–∏–Ω –±–æ—Ä—â' –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –Ω–∞ 100–≥"
Bot: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –≤–∞—à—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É"

Later:
User: "–°—ä–µ–ª 300–≥ –º–∞–º–∏–Ω –±–æ—Ä—â"
Bot: [–Ω–∞—Ö–æ–¥–∏—Ç –≤ custom library] ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: –º–∞–º–∏–Ω –±–æ—Ä—â 300–≥ (750 –∫–∫–∞–ª)
```

### 2. –§–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏ ‚Üí custom entry

GPT-4o Vision —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —ç—Ç–∏–∫–µ—Ç–∫—É ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç custom entry:
```
User: [—Ñ–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏]
Bot: "–ù–∞–π–¥–µ–Ω–æ: –ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫
      –ù–∞ 100–≥: 350 –∫–∫–∞–ª, –ë: 20–≥, –ñ: 10–≥, –£: 40–≥
      –°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º —Å—ä–µ–ª–∏?"
User: "60"
Bot: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç)
```

### 3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ entries

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å custom entry –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
```
/edit_last
Bot: "–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å: —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º 150–≥, 600 –∫–∫–∞–ª
      –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?"
User: "–í–µ—Å 200–≥"
Bot: ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ (–ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: 800 –∫–∫–∞–ª)
```

### 4. –≠–∫—Å–ø–æ—Ä—Ç custom library

–≠–∫—Å–ø–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö custom products –≤ CSV/JSON.

### 5. –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∏ —Å–∞—Ö–∞—Ä

–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–≤–æ–¥:
```
"–°–∞–ª–∞—Ç –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –∫–ª–µ—Ç—á–∞—Ç–∫–∞ 5 —Å–∞—Ö–∞—Ä 2 –Ω–∞ 100–≥"
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç-–∫–µ–π—Å—ã

**1. –ü—Ä—è–º–æ–π –≤–≤–æ–¥ —Å –≤–µ—Å–æ–º:**
- ‚úÖ "150–≥ —Å–∞–ª–∞—Ç –ë–ñ–£ 50/50/50 –∫–∞–ª–æ—Ä–∏–π 600"
- ‚úÖ "–û–º–ª–µ—Ç 200 –≥—Ä–∞–º–º –ö–ë–ñ–£ 300/30/20/10"
- ‚úÖ "–°—ä–µ–ª 100–≥ –ø—Ä–æ—Ç–µ–∏–Ω –∫–∞–ª–æ—Ä–∏–∏ 400 –±–µ–ª–∫–∏ 25 –∂–∏—Ä—ã 15 —É–≥–ª–µ–≤–æ–¥—ã 50"

**2. –ù–∞ 100–≥ —Å –≤–µ—Å–æ–º:**
- ‚úÖ "200–≥ —Å–∞–ª–∞—Ç –Ω–∞ 100–≥ –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250"
- ‚úÖ "150 –≥—Ä–∞–º–º –∫—É—Ä–∏—Ü–∞ per 100g calories 165 protein 31 fat 3.6 carbs 0"

**3. –ù–∞ 100–≥ –±–µ–∑ –≤–µ—Å–∞ (clarification):**
- ‚úÖ "–°–∞–ª–∞—Ç –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 250 –Ω–∞ 100–≥" ‚Üí –∑–∞–ø—Ä–æ—Å –≤–µ—Å–∞ ‚Üí –ø–µ—Ä–µ—Å—á—ë—Ç
- ‚úÖ "–ù–∞ 100 –≥—Ä–∞–º–º: –∫–∞–ª–æ—Ä–∏–∏ 350, –±–µ–ª–∫–∏ 20" ‚Üí –∑–∞–ø—Ä–æ—Å –≤–µ—Å–∞ ‚Üí –ø–µ—Ä–µ—Å—á—ë—Ç

**4. Edge cases:**
- ‚úÖ –¢–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–∏ –±–µ–∑ –ë–ñ–£
- ‚úÖ –ß–∞—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –±–µ–ª–∫–∏ –∏ –∫–∞–ª–æ—Ä–∏–∏)
- ‚úÖ –†–∞–∑–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã (–≥, –≥—Ä–∞–º–º, g, grams)
- ‚úÖ –°–º–µ—à–∞–Ω–Ω—ã–π —è–∑—ã–∫ (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)

### –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–í Telegram –±–æ—Ç–µ:**
```
/start  (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã)
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å custom –ö–ë–ñ–£
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
/today  (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å)
```

**–ü—Ä—è–º–æ–π API —Ç–µ—Å—Ç:**
```bash
curl -X POST http://localhost:8000/v1/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_id": 123456789,
    "input_type": "text",
    "raw_input": "–°—ä–µ–ª 150–≥ —Å–∞–ª–∞—Ç –ë–ñ–£ 50/50/50 –∫–∞–ª–æ—Ä–∏–π 600"
  }'
```

## –°—Ç–∞—Ç—É—Å

‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ò –†–ê–ó–í–Å–†–ù–£–¢–û**

- –ü–∞—Ä—Å–∏–Ω–≥ custom –ö–ë–ñ–£ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü–µ—Ä–µ—Å—á—ë—Ç —Å 100–≥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- Clarification flow –¥–ª—è –≤–µ—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å is_custom=True
- –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–∏–º–µ—Ä—ã —á—Ç–æ –ø–∏—Å–∞—Ç—å –≤ –±–æ—Ç:**
```
–°—ä–µ–ª 150–≥ —Å–∞–ª–∞—Ç–∞ –ë–ñ–£ 50/50/50 –∫–∞–ª–æ—Ä–∏–π 600
200–≥ –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –ö–ë–ñ–£ 330/62/7/0
–û–º–ª–µ—Ç –ë–ñ–£ 30/20/10 –∫–∞–ª–æ—Ä–∏–π 300 –Ω–∞ 100–≥
–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫ –Ω–∞ 100 –≥—Ä–∞–º–º: –∫–∞–ª–æ—Ä–∏–∏ 350, –±–µ–ª–∫–∏ 20, –∂–∏—Ä—ã 10, —É–≥–ª–µ–≤–æ–¥—ã 40
```

**–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:**
- –ï—Å–ª–∏ –≤–µ—Å —É–∫–∞–∑–∞–Ω ‚Üí —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- –ï—Å–ª–∏ –≤–µ—Å –ù–ï —É–∫–∞–∑–∞–Ω –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ 100–≥ ‚Üí –±–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç "–°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º?"
- –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ /today

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Ç—á—ë—Ç–∞–º–∏

Custom entries –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç—á—ë—Ç–∞—Ö —Ç–∞–∫ –∂–µ –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ:

```
üìä –û—Ç—á—ë—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è (7.2.2026)

‚úÖ –ö–∞–ª–æ—Ä–∏–∏: 1950 / 2000 –∫–∫–∞–ª (98%)
   [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë]

üìù –ó–∞–ø–∏—Å–µ–π: 8

–í —Ç–æ–º —á–∏—Å–ª–µ custom entries:
‚Ä¢ —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º 150–≥ (600 –∫–∫–∞–ª)  ‚Üê custom
‚Ä¢ –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ 200–≥ (330 –∫–∫–∞–ª)  ‚Üê custom
‚Ä¢ —è–π—Ü–∞ 2 —à—Ç (140 –∫–∫–∞–ª)  ‚Üê –∏–∑ FatSecret
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- [services/agent-api/src/graph/nodes/process_custom_nutrition.py](services/agent-api/src/graph/nodes/process_custom_nutrition.py)
- [services/agent-api/src/services/openai_service.py](services/agent-api/src/services/openai_service.py) (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
- [services/agent-api/src/graph/nodes/normalize_input.py](services/agent-api/src/graph/nodes/normalize_input.py) (routing)
- [services/agent-api/src/graph/graph.py](services/agent-api/src/graph/graph.py) (graph definition)
